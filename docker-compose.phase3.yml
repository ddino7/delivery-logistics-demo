version: "3.8"

services:
  redpanda:
    image: redpandadata/redpanda:latest
    container_name: phase3_redpanda
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - "1G"
      - --reserve-memory
      - "0M"
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://phase3_redpanda:9092
    ports:
      - "9092:9092"
    networks:
      - delivery-network
    restart: unless-stopped

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.9.0
    container_name: phase3_opensearch_dashboards
    environment:
      # Use Phase 2 OpenSearch (single source of truth)
      - OPENSEARCH_HOSTS=["http://phase2_opensearch:9200"]
      # Fix i18n crash you hit
      - I18N_LOCALE=en-US
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    ports:
      - "5601:5601"
    networks:
      - delivery-network
    restart: unless-stopped

  fluent-bit:
    image: cr.fluentbit.io/fluent/fluent-bit:2.2
    container_name: phase3_fluentbit_v2
    privileged: true
    command: ["/fluent-bit/bin/fluent-bit", "-c", "/tmp/fluent-bit.conf"]
    volumes:
      - ${PWD}/phase3/fluent-bit/fluent-bit.conf:/tmp/fluent-bit.conf:ro
      - ${PWD}/phase3/fluent-bit/parsers.conf:/tmp/parsers.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ${PWD}/phase3/fluent-bit/test-logs:/tmp/test-logs:ro
    networks:
      - delivery-network
    restart: unless-stopped

  location-consumer:
    build:
      context: ${PWD}/phase3/location-consumer
      dockerfile: Dockerfile
    container_name: phase3_location_consumer
    environment:
      - PYTHONUNBUFFERED=1
      - KAFKA_BOOTSTRAP_SERVERS=phase3_redpanda:9092
      - KAFKA_LOCATION_TOPIC=vehicle-location-events
      - MONGO_URI=mongodb://phase2_mongo_primary:27017
      - MONGO_DB_NAME=delivery_system
    networks:
      - delivery-network
    restart: unless-stopped

networks:
  delivery-network:
    external: true
    name: phase2_delivery-network

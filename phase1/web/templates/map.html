<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Vehicle Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .hud {
      position: absolute;
      z-index: 999;
      top: 12px;
      left: 12px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 14px;
      line-height: 1.35;
      min-width: 220px;
    }
    .hud small { opacity: 0.8; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="hud">
    <div><b>Live Vehicle Map</b></div>
    <div>Vozila: <span id="count">0</span></div>
    <small>Refresh: svake 2s</small>
    <div style="margin-top:8px;">
      <a href="/" style="color:#9ddcff;">← Nazad</a>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Karta start pozicija (Hrvatska)
    const map = L.map('map').setView([45.3, 14.4], 7);

    // Tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // cache-bust ikone (da browser ne drži staru/404)
    const iconUrl = '../static/icons/truck.png?v=' + Date.now();

    const vehicleIcon = L.icon({
      iconUrl,
      iconSize: [36, 36],
      iconAnchor: [18, 18],
      popupAnchor: [0, -18]
    });

    // vehicle_id -> marker
    const markers = new Map();

    async function fetchLatest() {
      const res = await fetch('/api/location/latest', { cache: 'no-store' });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error('HTTP ' + res.status + ' ' + text);
      }
      return res.json();
    }

    function upsertMarker(v) {
      const vehicleId = v.vehicle_id;
      const lat = Number(v.lat);
      const lng = Number(v.lng);
      if (!vehicleId || Number.isNaN(lat) || Number.isNaN(lng)) return;

      const popupHtml = `
        <b>Vehicle:</b> ${vehicleId}<br/>
        <b>Driver:</b> ${v.driver_id ?? 'unknown'}<br/>
        <b>Lat/Lng:</b> ${lat.toFixed(5)}, ${lng.toFixed(5)}<br/>
        <b>ts:</b> ${v.ts ?? '-'}<br/>
        <b>updated_at:</b> ${v.updated_at ?? '-'}
      `;

      if (markers.has(vehicleId)) {
        const marker = markers.get(vehicleId);
        marker.setLatLng([lat, lng]);
        marker.setPopupContent(popupHtml);
      } else {
        //  OVO JE KLJUČ: primijeni custom icon
        const marker = L.marker([lat, lng], { icon: vehicleIcon })
          .addTo(map)
          .bindPopup(popupHtml);

        markers.set(vehicleId, marker);
      }
    }

    async function tick() {
      try {
        const payload = await fetchLatest();
        const data = payload.data || [];

        document.getElementById('count').textContent = data.length;

        for (const v of data) upsertMarker(v);

      } catch (e) {
        console.error('Map refresh error:', e);
      }
    }

    // Debug: provjeri da se ikona uopće učitava (ako ovo faila -> putanja / permissions / nginx static)
    (function testIconLoad() {
      const img = new Image();
      img.onload = () => console.log('vehicle icon loaded:', iconUrl);
      img.onerror = () => console.error('vehicle icon NOT loaded:', iconUrl, 'Provjeri da postoji phase1/web/static/icons/truck.png');
      img.src = iconUrl;
    })();

    tick();
    setInterval(tick, 2000);
  </script>
</body>
</html>

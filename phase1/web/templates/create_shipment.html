{% extends "base.html" %}

{% block title %}Create Shipment - Delivery System{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üì¶ Create New Shipment</h1>
</div>

<div class="form-container">
    <form id="shipmentForm">
        
        <!-- ROUTE CONFIGURATION - NA POƒåETKU FORME -->
        <div class="form-section">
            <h2>Route Configuration</h2>
            <div class="form-group">
                <label for="pickup_city">Pickup City *</label>
                <select id="pickup_city" name="pickup_city" required>
                    <option value="">Select city</option>
                    <option value="Zagreb">Zagreb</option>
                    <option value="Split">Split</option>
                    <option value="Rijeka">Rijeka</option>
                    <option value="Osijek">Osijek</option>
                    <option value="Karlovac">Karlovac</option>
                    <option value="Zadar">Zadar</option>
                    <option value="Pula">Pula</option>
                    <option value="Dubrovnik">Dubrovnik</option>
                    <option value="Sibenik">≈†ibenik</option>
                    <option value="Varazdin">Vara≈ædin</option>
                    <option value="Slavonski Brod">Slavonski Brod</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="delivery_city">Delivery City *</label>
                <select id="delivery_city" name="delivery_city" required>
                    <option value="">Select city</option>
                    <option value="Zagreb">Zagreb</option>
                    <option value="Split">Split</option>
                    <option value="Rijeka">Rijeka</option>
                    <option value="Osijek">Osijek</option>
                    <option value="Karlovac">Karlovac</option>
                    <option value="Zadar">Zadar</option>
                    <option value="Pula">Pula</option>
                    <option value="Dubrovnik">Dubrovnik</option>
                    <option value="Sibenik">≈†ibenik</option>
                    <option value="Varazdin">Vara≈ædin</option>
                    <option value="Slavonski Brod">Slavonski Brod</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="optimize_by">Optimize Route By</label>
                <select id="optimize_by" name="optimize_by">
                    <option value="time">‚è±Ô∏è Time (Fastest)</option>
                    <option value="distance">üìè Distance (Shortest)</option>
                    <option value="cost">üí∞ Cost (Cheapest)</option>
                </select>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Sender Information</h2>
            <div class="form-group">
                <label for="sender_name">Name *</label>
                <input type="text" id="sender_name" name="sender_name" required>
            </div>
            <div class="form-group">
                <label for="sender_phone">Phone</label>
                <input type="tel" id="sender_phone" name="sender_phone">
            </div>
            <div class="form-group">
                <label for="sender_email">Email</label>
                <input type="email" id="sender_email" name="sender_email">
            </div>
        </div>

        <div class="form-section">
            <h2>Receiver Information</h2>
            <div class="form-group">
                <label for="receiver_name">Name *</label>
                <input type="text" id="receiver_name" name="receiver_name" required>
            </div>
            <div class="form-group">
                <label for="receiver_phone">Phone</label>
                <input type="tel" id="receiver_phone" name="receiver_phone">
            </div>
            <div class="form-group">
                <label for="receiver_email">Email</label>
                <input type="email" id="receiver_email" name="receiver_email">
            </div>
        </div>

        <div class="form-section">
            <h2>Shipment Details</h2>
            <div class="form-group">
                <label for="weight">Weight (kg) *</label>
                <input type="number" id="weight" name="weight" step="0.1" min="0.1" required>
            </div>
            <div class="form-group">
                <label for="pickup_address">Pickup Address *</label>
                <textarea id="pickup_address" name="pickup_address" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="delivery_address">Delivery Address *</label>
                <textarea id="delivery_address" name="delivery_address" rows="3" required></textarea>
            </div>
        </div>

        <div class="form-section">
            <h2>Products</h2>
            <div id="products-container">
                <div class="product-item">
                    <input type="text" name="product_name[]" placeholder="Product name">
                    <input type="number" name="product_quantity[]" placeholder="Quantity" min="1" value="1">
                </div>
            </div>
            <button type="button" class="btn btn-secondary" onclick="addProduct()">+ Add Product</button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Create Shipment</button>
            <button type="reset" class="btn btn-secondary">Reset Form</button>
        </div>
    </form>

    <div id="result" class="result-box" style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let productCount = 1;

function addProduct() {
    const container = document.getElementById('products-container');
    const productItem = document.createElement('div');
    productItem.className = 'product-item';
    productItem.innerHTML = `
        <input type="text" name="product_name[]" placeholder="Product name">
        <input type="number" name="product_quantity[]" placeholder="Quantity" min="1" value="1">
        <button type="button" class="btn-remove" onclick="this.parentElement.remove()">√ó</button>
    `;
    container.appendChild(productItem);
    productCount++;
}

document.getElementById('shipmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const resultBox = document.getElementById('result');
    resultBox.style.display = 'block';
    resultBox.innerHTML = '<p>Creating shipment...</p>';
    
    // Collect form data
    const formData = new FormData(e.target);
    
    // Build products array
    const productNames = formData.getAll('product_name[]');
    const productQuantities = formData.getAll('product_quantity[]');
    const products = productNames
        .map((name, i) => ({
            name: name,
            quantity: parseInt(productQuantities[i]) || 1
        }))
        .filter(p => p.name.trim() !== '');
    
    // Build shipment data
    const shipmentData = {
        sender: {
            name: formData.get('sender_name'),
            phone: formData.get('sender_phone'),
            email: formData.get('sender_email')
        },
        receiver: {
            name: formData.get('receiver_name'),
            phone: formData.get('receiver_phone'),
            email: formData.get('receiver_email')
        },
        weight: parseFloat(formData.get('weight')),
        pickup_address: formData.get('pickup_address'),
        delivery_address: formData.get('delivery_address'),
        pickup_city: formData.get('pickup_city'),
        delivery_city: formData.get('delivery_city'),
        optimize_by: formData.get('optimize_by'),
        products: products
    };
    
    console.log('Sending shipment data:', shipmentData);
    
    try {
        const response = await fetch('/api/shipments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(shipmentData)
        });
        
        const data = await response.json();
        console.log('Response:', data);
        
        if (response.ok) {
            resultBox.className = 'result-box success';
            
            let routeHtml = '';
            if (data.route) {
                routeHtml = `
                    <div class="route-result">
                        <h4>üó∫Ô∏è Calculated Route:</h4>
                        <p><strong>Path:</strong> ${data.route.path.join(' ‚Üí ')}</p>
                        <p><strong>Distance:</strong> ${data.route.distance_km} km</p>
                        <p><strong>Time:</strong> ${data.route.time_hours.toFixed(1)} hours</p>
                        <p><strong>Cost:</strong> ${data.route.cost_eur.toFixed(2)} EUR</p>
                        <p><strong>Optimized by:</strong> ${data.route.optimized_by}</p>
                        ${data.predicted_delivery_hours ? `<p><strong>AI ETA:</strong> ${data.predicted_delivery_hours.toFixed(2)} hours <span style="margin-left:6px;padding:2px 6px;background:#e8f5e9;border-radius:4px;border:1px solid #c8e6c9;font-size:0.85em;color:#2e7d32;">${data.prediction_source || 'heuristic'}</span></p>` : ''}
                    </div>
                `;
            }
            
            resultBox.innerHTML = `
                <h3>‚úì Shipment Created Successfully!</h3>
                <p><strong>Tracking Number:</strong> <span class="tracking-number">${data.tracking_number}</span></p>
                ${routeHtml}
                <p>You can track your shipment using this tracking number.</p>
                <a href="/track?tracking=${data.tracking_number}" class="btn btn-primary">Track Now</a>
            `;
            e.target.reset();
        } else {
            resultBox.className = 'result-box error';
            resultBox.innerHTML = `<p>Error: ${data.error}</p>`;
        }
    } catch (error) {
        resultBox.className = 'result-box error';
        resultBox.innerHTML = `<p>Error: ${error.message}</p>`;
    }
});
</script>
{% endblock %}

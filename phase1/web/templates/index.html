{% extends "base.html" %}

{% block title %}Home - Delivery System{% endblock %}

{% block content %}
<div class="hero">
    <h1>Welcome to Delivery Management System</h1>
</div>

<div class="features">
    <div class="feature-card">
        <h2>Create Shipment</h2>
        <p>Create new shipments with detailed sender, receiver, and product information.</p>
        <a href="/create" class="btn btn-primary">Create Now</a>
    </div>

    <div class="feature-card">
        <h2>Track Shipment</h2>
        <p>Track your shipment using the tracking number and see real-time status updates.</p>
        <a href="/track" class="btn btn-primary">Track Now</a>
    </div>

    <div class="feature-card">
        <h2>All Shipments</h2>
        <p>View all created shipments and search by tracking number.</p>
        <a href="/shipments" class="btn btn-primary">View All</a>
    </div>

    <div class="feature-card">
        <h2>Live Map</h2>
        <p>Open live map view for real-time vehicle locations.</p>
        <a href="/map" class="btn btn-primary">Live Map</a>
    </div>

    <div class="feature-card">
        <h2>Test Logistics Network</h2>
        <p>View distribution centers, warehouses and calculate optimal routes between locations.</p>
        <a href="/network" class="btn btn-primary">View Network</a>
    </div>

    <div class="feature-card">
        <h2>System Status</h2>
        <p>Check the system health and database connection status.</p>
        <button class="btn btn-secondary" onclick="checkHealth()">Check Status</button>
    </div>
</div>

<div id="system-status" class="status-box" style="display: none;">
    <h3>System Status</h3>
    <div id="status-content"></div>
</div>

<div class="info-section">
    <h2>System Architecture</h2>
    <ul class="architecture-list">
    <li>
        <strong>Phase 1 – Shipment Management:</strong>
        Creation of shipments with sender/receiver details, weight, addresses and product lists.
        Supports shipment status updates (created, in warehouse, in delivery, delivered) and
        tracking by tracking number. Built on a load-balanced web layer with a document-oriented
        database using replication for reliable and scalable storage of shipments, suppliers and products.
    </li>

    <li>
        <strong>Phase 2 – Logistics Network:</strong>
        Visualization of distribution centers and warehouses with optimal route calculation
        between locations. Introduces a graph database to model logistics infrastructure as nodes
        and routes as relationships with distance, time and cost attributes, enabling efficient
        network analysis.
    </li>

    <li>
        <strong>Phase 3 – Real-Time Tracking & Analytics:</strong>
        Real-time GPS event streaming from delivery vehicles, allowing live vehicle tracking.
        Advanced shipment search by tracking number, status and recipient.
        Includes event streaming, centralized logging, indexing and search,
        and dashboards for key metrics such as shipment status distribution,
        average delivery time and delays.
    </li>

    <li>
        <strong>Phase 4 – Predictive Delivery (Optional):</strong>
        Estimation of delivery times based on historical shipment data,
        route distances and real-time GPS information.
        Integrates batch data processing and a model serving system
        to support machine learning–based predictions.
    </li>
</ul>
</div>

{% endblock %}

{% block scripts %}
<script>
async function checkHealth() {
    const statusBox = document.getElementById('system-status');
    const statusContent = document.getElementById('status-content');

    statusBox.style.display = 'block';
    statusContent.innerHTML = '<p>Loading system health...</p>';

    try {
        const response = await fetch('/health');
        const data = await response.json();

        let simulatorInfo = data.vehicle_simulator;
        if (data.vehicle_simulator === 'active' && data.simulator_count > 0) {
            simulatorInfo = `active (${data.simulator_count} simulations)`;
        }

        statusContent.innerHTML = `
            <div class="health-grid">
                <div class="health-item ${data.status === 'healthy' ? 'healthy' : 'unhealthy'}">
                    <span class="label">Overall Status</span>
                    <span class="value">${data.status.toUpperCase()}</span>
                </div>

                <div class="health-item">
                    <span class="label">Server ID</span>
                    <span class="value">${data.server_id}</span>
                </div>

                <div class="health-item ${getHealthClass(data.mongodb)}">
                    <span class="label">MongoDB</span>
                    <span class="value">${data.mongodb}</span>
                </div>

                <div class="health-item ${getHealthClass(data.neo4j)}">
                    <span class="label">Neo4j</span>
                    <span class="value">${data.neo4j}</span>
                </div>

                <div class="health-item ${getHealthClass(data.opensearch)}">
                    <span class="label">OpenSearch</span>
                    <span class="value">${data.opensearch}</span>
                </div>

                <div class="health-item ${getHealthClass(data.eta)}">
                    <span class="label">ETA Service</span>
                    <span class="value">${data.eta}</span>
                </div>

                <div class="health-item ${getHealthClass(data.vehicle_simulator)}">
                    <span class="label">Vehicle Simulator</span>
                    <span class="value">${simulatorInfo}</span>
                </div>

                <div class="health-item">
                    <span class="label">Timestamp</span>
                    <span class="value">${new Date(data.timestamp * 1000).toLocaleString()}</span>
                </div>
            </div>
        `;
    } catch (error) {
        statusContent.innerHTML = `
            <div class="health-item error">
                <span class="value">❌ Failed to fetch system health</span>
            </div>
        `;
    }
}

function getHealthClass(status) {
    if (status === 'healthy' || status === 'active' || status === 'model') {
        return 'healthy';
    } else if (status === 'not_configured' || status === 'heuristic') {
        return 'warning';
    } else if (status && status.toString().includes('unhealthy')) {
        return 'unhealthy';
    }
    return '';
}
</script>
{% endblock %}
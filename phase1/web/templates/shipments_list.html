{% extends "base.html" %}

{% block title %}All Shipments{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìã All Shipments</h1>
    <a href="/create" class="btn btn-primary">‚ûï Create New Shipment</a>
</div>

<div class="search-section">
    <input type="text" id="searchBox" placeholder="Search by tracking, sender, receiver..." />
    <select id="statusFilter">
        <option value="">All Statuses</option>
        <option value="CREATED">Created</option>
        <option value="IN_WAREHOUSE">In Warehouse</option>
        <option value="IN_TRANSIT">In Transit</option>
        <option value="DELIVERED">Delivered</option>
    </select>
</div>

<div id="shipmentsContainer">
    <p>Loading shipments...</p>
</div>

<!-- Update Status Modal -->
<div id="statusModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h2>Update Shipment Status</h2>
        <p><strong>Tracking:</strong> <span id="modalTracking"></span></p>
        <div class="form-group">
            <label>New Status:</label>
            <select id="newStatus">
                <option value="IN_WAREHOUSE">In Warehouse</option>
                <option value="IN_TRANSIT">In Transit</option>
                <option value="DELIVERED">Delivered</option>
            </select>
        </div>
        <div class="form-group">
            <label>Note:</label>
            <input type="text" id="statusNote" placeholder="Optional note..." />
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="updateStatus()">Update</button>
            <button class="btn btn-secondary" onclick="closeModal('statusModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Edit Shipment Modal -->
<div id="editModal" class="modal" style="display:none;">
    <div class="modal-content modal-large">
        <h2>Edit Shipment</h2>
        <p><strong>Tracking:</strong> <span id="editModalTracking"></span></p>
        
        <div class="form-row">
            <div class="form-group">
                <label>Sender Name:</label>
                <input type="text" id="editSenderName" />
            </div>
            <div class="form-group">
                <label>Sender Phone:</label>
                <input type="text" id="editSenderPhone" />
            </div>
            <div class="form-group">
                <label>Sender Email:</label>
                <input type="email" id="editSenderEmail" />
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Receiver Name:</label>
                <input type="text" id="editReceiverName" />
            </div>
            <div class="form-group">
                <label>Receiver Phone:</label>
                <input type="text" id="editReceiverPhone" />
            </div>
            <div class="form-group">
                <label>Receiver Email:</label>
                <input type="email" id="editReceiverEmail" />
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Weight (kg):</label>
                <input type="number" id="editWeight" step="0.1" />
            </div>
            <div class="form-group">
                <label>Pickup Address:</label>
                <textarea id="editPickupAddress" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>Delivery Address:</label>
                <textarea id="editDeliveryAddress" rows="2"></textarea>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h2>‚ö†Ô∏è Delete Shipment</h2>
        <p>Are you sure you want to delete this shipment?</p>
        <p><strong>Tracking:</strong> <span id="deleteModalTracking"></span></p>
        <p class="warning-text">This action cannot be undone!</p>
        <div class="modal-actions">
            <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
        </div>
    </div>
</div>

<script>
let allShipments = [];
let currentTracking = '';
let currentShipment = null;

async function loadShipments() {
    try {
        const response = await fetch('/api/shipments/?limit=100');
        const data = await response.json();
        allShipments = data.shipments;
        displayShipments(allShipments);
    } catch (error) {
        document.getElementById('shipmentsContainer').innerHTML = 
            `<p class="error">Error: ${error.message}</p>`;
    }
}

function displayShipments(shipments) {
    const container = document.getElementById('shipmentsContainer');
    
    if (shipments.length === 0) {
        container.innerHTML = '<p>No shipments found.</p>';
        return;
    }
    
    const html = shipments.map(s => `
        <div class="shipment-card">
            <div class="shipment-header">
                <strong>${s.tracking_number}</strong>
                <span class="status-badge status-${s.status.toLowerCase().replace('_', '-')}">${s.status.replace('_', ' ')}</span>
            </div>
            <div class="shipment-details">
                <p><strong>From:</strong> ${s.sender.name} (${s.pickup_address})</p>
                <p><strong>To:</strong> ${s.receiver.name} (${s.delivery_address})</p>
                <p><strong>Weight:</strong> ${s.weight} kg | <strong>Products:</strong> ${s.products ? s.products.length : 0}</p>
                ${s.route ? `
                    <div class="route-info">
                        <p><strong>üó∫Ô∏è Route:</strong> ${s.route.locations.map(l => l.city).join(' ‚Üí ')}</p>
                        <p><strong>üìè</strong> ${s.route.total_distance_km} km | 
                           <strong>‚è±Ô∏è</strong> ${s.route.total_time_hours.toFixed(1)} h | 
                           <strong>üí∞</strong> ${s.route.total_cost_eur.toFixed(2)} EUR</p>
                    </div>
                ` : '<p class="warning">‚ö†Ô∏è No route calculated</p>'}
                <p><strong>Created:</strong> ${new Date(s.created_at).toLocaleString()}</p>
            </div>
            <div class="shipment-actions">
                <button class="btn btn-primary btn-sm" onclick="trackShipment('${s.tracking_number}')">üìç Track</button>
                <button class="btn btn-secondary btn-sm" onclick="openStatusModal('${s.tracking_number}')">üîÑ Status</button>
                <button class="btn btn-info btn-sm" onclick="openEditModal('${s.tracking_number}')">‚úèÔ∏è Edit</button>
                <button class="btn btn-danger btn-sm" onclick="openDeleteModal('${s.tracking_number}')">üóëÔ∏è Delete</button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function trackShipment(tracking) {
    window.location.href = `/track?tracking=${tracking}`;
}

// ========== STATUS UPDATE ==========
function openStatusModal(tracking) {
    currentTracking = tracking;
    document.getElementById('modalTracking').textContent = tracking;
    document.getElementById('statusModal').style.display = 'flex';
}

async function updateStatus() {
    const newStatus = document.getElementById('newStatus').value;
    const note = document.getElementById('statusNote').value;
    
    try {
        const response = await fetch(`/api/shipments/${currentTracking}/status`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status: newStatus, note: note})
        });
        
        if (response.ok) {
            alert('‚úì Status updated successfully!');
            closeModal('statusModal');
            loadShipments();
        } else {
            const data = await response.json();
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// ========== EDIT SHIPMENT ==========
async function openEditModal(tracking) {
    currentTracking = tracking;
    
    try {
        const response = await fetch(`/api/shipments/${tracking}`);
        const data = await response.json();
        currentShipment = data;
        
        document.getElementById('editModalTracking').textContent = tracking;
        document.getElementById('editSenderName').value = data.sender.name || '';
        document.getElementById('editSenderPhone').value = data.sender.phone || '';
        document.getElementById('editSenderEmail').value = data.sender.email || '';
        document.getElementById('editReceiverName').value = data.receiver.name || '';
        document.getElementById('editReceiverPhone').value = data.receiver.phone || '';
        document.getElementById('editReceiverEmail').value = data.receiver.email || '';
        document.getElementById('editWeight').value = data.weight;
        document.getElementById('editPickupAddress').value = data.pickup_address;
        document.getElementById('editDeliveryAddress').value = data.delivery_address;
        
        document.getElementById('editModal').style.display = 'flex';
    } catch (error) {
        alert('Error loading shipment: ' + error.message);
    }
}

async function saveEdit() {
    const updatedData = {
        sender: {
            name: document.getElementById('editSenderName').value,
            phone: document.getElementById('editSenderPhone').value,
            email: document.getElementById('editSenderEmail').value
        },
        receiver: {
            name: document.getElementById('editReceiverName').value,
            phone: document.getElementById('editReceiverPhone').value,
            email: document.getElementById('editReceiverEmail').value
        },
        weight: parseFloat(document.getElementById('editWeight').value),
        pickup_address: document.getElementById('editPickupAddress').value,
        delivery_address: document.getElementById('editDeliveryAddress').value
    };
    
    try {
        const response = await fetch(`/api/shipments/${currentTracking}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(updatedData)
        });
        
        if (response.ok) {
            alert('‚úì Shipment updated successfully!');
            closeModal('editModal');
            loadShipments();
        } else {
            const data = await response.json();
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// ========== DELETE SHIPMENT ==========
function openDeleteModal(tracking) {
    currentTracking = tracking;
    document.getElementById('deleteModalTracking').textContent = tracking;
    document.getElementById('deleteModal').style.display = 'flex';
}

async function confirmDelete() {
    try {
        const response = await fetch(`/api/shipments/${currentTracking}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('‚úì Shipment deleted successfully!');
            closeModal('deleteModal');
            loadShipments();
        } else {
            const data = await response.json();
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// ========== MODAL HELPERS ==========
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// ========== SEARCH & FILTER ==========
document.getElementById('searchBox').addEventListener('input', filterShipments);
document.getElementById('statusFilter').addEventListener('change', filterShipments);

function filterShipments() {
    const search = document.getElementById('searchBox').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    
    const filtered = allShipments.filter(s => {
        const matchesSearch = !search || 
            s.tracking_number.toLowerCase().includes(search) ||
            (s.sender.name || '').toLowerCase().includes(search) ||
            (s.receiver.name || '').toLowerCase().includes(search);
        
        const matchesStatus = !status || s.status === status;
        
        return matchesSearch && matchesStatus;
    });
    
    displayShipments(filtered);
}

loadShipments();
</script>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.search-section {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.search-section input, .search-section select {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
}

.search-section input { flex: 1; }

.shipment-card {
    background: white;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.shipment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #ecf0f1;
}

.status-badge {
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.85rem;
    font-weight: bold;
}

.status-created { background-color: #3498db; color: white; }
.status-in-warehouse { background-color: #f39c12; color: white; }
.status-in-transit { background-color: #9b59b6; color: white; }
.status-delivered { background-color: #27ae60; color: white; }

.route-info {
    background-color: #e8f5e9;
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    border-left: 4px solid #27ae60;
}

.warning {
    color: #f39c12;
    font-style: italic;
}

.shipment-actions {
    display: flex;
    gap: 10px;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #ecf0f1;
    flex-wrap: wrap;
}

.btn-sm {
    padding: 8px 12px;
    font-size: 0.9rem;
}

.btn-info {
    background-color: #3498db;
    color: white;
}

.btn-info:hover {
    background-color: #2980b9;
}

.btn-danger {
    background-color: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background-color: #c0392b;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-large {
    max-width: 800px;
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.warning-text {
    color: #e74c3c;
    font-weight: bold;
    margin: 1rem 0;
}
</style>
{% endblock %}
